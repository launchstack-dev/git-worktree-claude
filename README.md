# git-worktree-claude

Git worktree management designed for [Claude Code](https://docs.anthropic.com/en/docs/claude-code). Creates isolated workspaces with hard boundaries so parallel Claude instances don't step on each other.

## The Problem

When running multiple Claude Code sessions on the same repo:
- Sessions drift between directories and make changes in the wrong place
- No enforcement that Claude stays in its assigned workspace
- Manual worktree tracking in CLAUDE.md goes stale immediately
- Full directory copies (`project-copy`, `project-debug`) clutter your disk

## The Solution

A set of shell functions that manage git worktrees with Claude-aware isolation:

| Command | Purpose |
|---------|---------|
| `wt <name> [base]` | Create worktree, inject Claude context, cd into it |
| `wt-list` | List worktrees with status + stale detection |
| `wt-merge [name]` | Merge into base branch with pre-merge diff + lockfile |
| `wt-cleanup <name>` | Remove worktree, update CLAUDE.md map |
| `wtc <name>` | Quick cd into existing worktree |
| `wt-help` | Show all commands |

## What `wt` Does

When you run `wt my-feature`:

1. Creates `.worktrees/my-feature/` via `git worktree add`
2. Writes `.worktree.json` metadata (branch, base branch, timestamps)
3. Symlinks shared Claude config (hooks, skills, agents) from main repo
4. Copies local Claude config (settings.json) so worktrees can diverge
5. Appends isolation rules to the worktree's `CLAUDE.md`
6. Generates a [hookify](https://github.com/anthropics/claude-code-plugins) boundary guard that warns when Claude edits files outside the worktree
7. Updates the main repo's `CLAUDE.md` worktree map (if markers exist)
8. Runs project setup (npm/bun/pip/cargo install)
9. `cd`s you into the worktree, ready to run `claude`

## Install

```bash
# 1. Copy scripts
mkdir -p ~/.claude/scripts
cp wt.sh ~/.claude/scripts/wt.sh
cp wt-guard.sh ~/.claude/scripts/wt-guard.sh
chmod +x ~/.claude/scripts/wt-guard.sh

# 2. Source in your shell
echo 'source "$HOME/.claude/scripts/wt.sh"' >> ~/.zshrc
source ~/.zshrc

# 3. Verify
wt-help
```

**Requires:** `git`, `jq` (`brew install jq`)

## Setup Per Project

### CLAUDE.md Template (Recommended)

Add this section to your project's `CLAUDE.md` to enable the auto-updating worktree map:

```markdown
## Git Worktree Discipline -- READ FIRST

**At session start**, verify your location:

\`\`\`bash
pwd && git branch --show-current && git worktree list
\`\`\`

### Active Worktrees

<!-- WORKTREE-MAP-START -->
| Branch | Base | Path | Status |
|--------|------|------|--------|
| _(none)_ | | | |
<!-- WORKTREE-MAP-END -->

### Strict Rules

1. Never switch branches inside a worktree.
2. Never commit on orphaned branches without explicit instruction.
3. If worktrees exist above, do NOT make feature changes in this main repo directory.
4. Do not create worktrees yourself — tell user to run `wt <name>`.
5. If unsure which worktree you are in, ask.
```

The table between `WORKTREE-MAP-START` and `WORKTREE-MAP-END` is automatically regenerated by `wt` and `wt-cleanup`. If the markers don't exist, the map update is silently skipped.

### Main Repo Guard Hook (Optional)

Install `wt-guard.sh` as a PreToolUse hook to prompt when Claude edits source files in the main repo while worktrees exist. This catches the "oops, wrong directory" case.

Add to your project's `.claude/settings.json`:

```json
{
  "hooks": {
    "PreToolUse": [{
      "matcher": "Write|Edit",
      "hooks": [{
        "type": "command",
        "command": "bash ~/.claude/scripts/wt-guard.sh",
        "timeout": 5000
      }]
    }]
  }
}
```

The guard:
- Exits immediately (zero overhead) if no `.worktrees/` directory exists
- Allows edits inside worktrees
- Allows config files (`.gitignore`, `CLAUDE.md`, `*.json`, `*.lock`, etc.)
- Prompts (doesn't block) for source files in the main repo

## Usage

```bash
# Create a worktree for a feature
cd my-project
wt auth-feature

# Now in .worktrees/auth-feature/ on branch auth-feature
# Launch Claude here
claude

# --- In another terminal ---

# Create another worktree from a different base
wt bugfix-login main

# List all worktrees
wt-list

# When done, merge back
wt-merge auth-feature

# Or just clean up without merging
wt-cleanup bugfix-login
```

## How It Keeps Claude Isolated

### Layer 1: CLAUDE.md Context

Each worktree gets isolation rules appended to its `CLAUDE.md`:

```markdown
## Worktree Context -- READ THIS FIRST

**You are in a worktree.** This is an isolated workspace.

| Field | Value |
|-------|-------|
| Project | `my-project` |
| Branch | `auth-feature` |
| Base branch | `main` |
| Worktree path | `/Users/me/my-project/.worktrees/auth-feature` |
| Main repo | `/Users/me/my-project` |

### Hard Rules
1. Stay in this directory.
2. Do not switch branches.
3. Do not read/modify files in other worktrees.
4. PRs target `main`.
...
```

### Layer 2: Hookify Boundary Guard

Each worktree gets a `.claude/hookify.worktree-boundary.local.md` rule that warns when Claude tries to edit files outside the worktree path. Requires the [hookify plugin](https://github.com/anthropics/claude-code-plugins).

### Layer 3: Main Repo Guard (Optional)

The `wt-guard.sh` hook prompts when Claude edits source files in the main repo while worktrees exist.

## Parallel Safety

| Scenario | Solution |
|----------|----------|
| Two Claudes merge simultaneously | PID-based lockfile with stale detection |
| Claude A edits in Claude B's worktree | CLAUDE.md rules + hookify boundary guard |
| Main CLAUDE.md map goes stale | Auto-regenerated on every `wt` and `wt-cleanup` |

## Compatibility

- Works with the [superpowers `using-git-worktrees` skill](https://github.com/anthropics/claude-code-plugins) — uses the same `.worktrees/` location
- Worktrees created by other tools show in `wt-list` via `git worktree list` cross-reference
- Shell: bash and zsh

## License

MIT
